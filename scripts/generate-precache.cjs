const fs = require('fs');
const path = require('path');

const ROOT = path.resolve(__dirname, '..');

const listFiles = (baseDir, options) => {
    const { extensions, recursive = false, prefix = '' } = options;
    const results = [];

    const dirPath = path.join(ROOT, baseDir);

    if (!fs.existsSync(dirPath)) {
        return results;
    }

    const entries = fs.readdirSync(dirPath, { withFileTypes: true });
    for (const entry of entries) {
        const relative = path.join(prefix, entry.name);
        const fullPath = path.join(dirPath, entry.name);
        if (entry.isDirectory()) {
            if (recursive) {
                results.push(...listFiles(path.join(baseDir, entry.name), { extensions, recursive, prefix: relative }));
            }
            continue;
        }
        const matchesExtension = extensions.some((ext) => entry.name.toLowerCase().endsWith(ext));
        if (matchesExtension) {
            results.push(`/${relative.replace(/\\/g, '/')}`);
        }
    }
    return results;
};

const files = new Set([
    '/',
    '/index.html',
    '/manifest.webmanifest',
    '/favicon.png'
]);

[
    ...listFiles('html', { extensions: ['.html'], recursive: true, prefix: 'html' }),
    ...listFiles('css', { extensions: ['.css'], recursive: false, prefix: 'css' }),
    ...listFiles('assets', { extensions: ['.svg', '.png', '.jpg', '.jpeg', '.ogg', '.mp3', '.wav'], recursive: true, prefix: 'assets' }),
    ...listFiles('dist', { extensions: ['.js'], recursive: true, prefix: 'dist' })
].forEach((file) => files.add(file));

const urls = Array.from(files).sort();

const outputPath = path.join(ROOT, 'src', 'precache-manifest.ts');
const template = `/**
 * AUTO-GENERATED FILE - DO NOT EDIT
 *
 * This file is automatically generated by scripts/generate-precache.cjs
 * Run "npm run build" or "npm run prebuild" to regenerate.
 */

export const PRECACHE_URLS = ${JSON.stringify(urls, null, 4)} as const;
`;

fs.writeFileSync(outputPath, template);

console.log(`Generated ${urls.length} precache urls.`);
